from PySide6.QtWidgets import QListWidget, QListWidgetItem
from ..models.movie import Movie
from ..utils.my_functions import link_to_image
from ..db.sqlite_manger import list_movies  # or your JSON loader
from ...py_ui.movie_list_widget import MovieListItemWidget
from PySide6.QtCore import Qt

class MovieListLoader:
    """Handles loading movies into a QListWidget."""

    def __init__(self, list_widget: QListWidget):
        self.list_widget = list_widget

    def load_movies(self, movies: list[Movie]):
        """Populate the QListWidget with a list of Movie objects."""
        self.list_widget.clear()

        for index, movie in enumerate(movies, start=1):
            item_widget = MovieListItemWidget(movie, index=index)
            item = QListWidgetItem(self.list_widget)
            item.setSizeHint(item_widget.sizeHint())

            # Store movie object for later retrieval
            item.setData(33, movie)  # Qt.UserRole + 1 = 33 (just as an example)

            # Disable selection if needed
            item.setFlags(item.flags() & ~Qt.ItemFlag.ItemIsSelectable)

            self.list_widget.addItem(item)
            self.list_widget.setItemWidget(item, item_widget)

    def load_from_section(self, section: str, order_by="title", descending=False):
        """Fetch movies from DB by section and load them."""
        movies = list_movies(section=section, order_by=order_by, descending=descending)
        self.load_movies(movies)
